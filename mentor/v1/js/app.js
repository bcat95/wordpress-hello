let data_index="",employee_name="",employee_expert="",employee_image="",employee_background_color="",employee_training="",chat_font_size="",dalle_img_size="",CHAT_PHP_url="php/api.php",DALLE_PHP_url="php/dall-e-2.php",API_URL="",API_MODEL="",source="",google_voice="",google_voice_lang_code="",microphone_speak_lang="",dalle_generated_img_count=1,chat_minlength=0,chat_maxlength=0,employee_temperature=1,employee_frequency_penalty=0,employee_presence_penalty=0,lang_index=0,scrollPosition=0,shuffle_character=!1,is_model_turbo=!1,use_text_stream=!1,display_microphone_in_chat=!1,display_avatar_in_chat=!1,display_contacts_user_list=!1,display_copy_text_button_in_chat=!1,filter_badwords=!0,display_audio_button_answers=!0,chat_history=!0,hasBadWord=!1,chat=[],pmt=[],array_employees=[],array_chat=[],lang=[],badWords=[],array_messages=[],array_voices=[],filterBotWords=["Robot:","Bot:"];function loadData(e,t){return Promise.all([fetch(e).then((e=>e.json())),...t.map((e=>fetch(e).then((e=>e.json()))))]).then((([e,t,a,n])=>{function s(e,t){e.empty(),$.each(t,(function(t,a){e.append($("<option>").val(a.value).text(a.label))}))}lang=a,filter_badwords&&(badWords=n.badwords.split(",")),lang_index=lang.use_lang_index,use_text_stream=e.use_text_stream,display_avatar_in_chat=e.display_avatar_in_chat,display_microphone_in_chat=e.display_microphone_in_chat,microphone_speak_lang=e.microphone_speak_lang,display_contacts_user_list=e.display_contacts_user_list,display_copy_text_button_in_chat=e.display_copy_text_button_in_chat,display_audio_button_answers=e.display_audio_button_answers,filter_badwords=e.filter_badwords,chat_history=e.chat_history,chat_font_size=e.chat_font_size,dalle_img_size=e.dalle_img_size,dalle_generated_img_count=e.dalle_generated_img_count,shuffle_character=e.shuffle_character;s($("#display_chat_language_output #selectLanguage"),lang.translate[lang_index].display_chat_language_output);s($("#display_chat_tone #selectTone"),lang.translate[lang_index].display_chat_tone);s($("#display_chat_writing_style #selectWritingStyle"),lang.translate[lang_index].display_chat_writing_style),copy_text_in_chat=display_copy_text_button_in_chat?`<button class="copy-text" onclick="copyText(this)"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> <span class="label-copy-code">${lang.translate[lang_index].copy_text1}</span></button>`:"";var o=document.createElement("style");o.innerHTML=".message-text{font-size:"+chat_font_size+" !important;}",document.head.appendChild(o),shuffle_character&&(t=shuffleArray(t)),display_contacts_user_list||($(".toggle_employees_list").hide(),$(".col-contacts-border").hide()),display_microphone_in_chat&&$("#microphone-button").show(),$("#load-character").html(""),$(".ai-contacts-scroll").html("");for(var i=0;i<t.length;i++)array_employees.push({name:t[i].name,image:t[i].image,description:t[i].description,welcome_message:t[i].welcome_message,display_welcome_message:t[i].display_welcome_message,expert:t[i].expert,background_thumb_color:t[i].background_thumb_color,training:t[i].training,temperature:t[i].temperature,frequency_penalty:t[i].frequency_penalty,presence_penalty:t[i].presence_penalty,chat_minlength:t[i].chat_minlength,chat_maxlength:t[i].chat_maxlength,max_num_chats_api:t[i].max_num_chats_api,API_MODEL:t[i].API_MODEL,google_voice:t[i].google_voice,google_voice_lang_code:t[i].google_voice_lang_code}),$(".ai-contacts-scroll").append(`\n            <div class="ai-contacts-item ai_contacts_active_${i}" data-index="${i}">\n              <div class="ai-contacts-image"><img src="${array_employees[i].image}" onerror="this.src='img/no-image.svg'" alt="${array_employees[i].name}" title="${array_employees[i].name}"></div>\n              <div class="ai-contacts-info">\n                <div class="ai-contacts-name">${array_employees[i].name}</div>\n                <div class="ai-contacts-job" alt="${array_employees[i].expert}">${array_employees[i].expert}</div>\n              </div>\n            </div>        \t\n        `),$("#load-character").append(`\n\n\t\t\t\t\t<div class="col-lg-3 col-md-4" data-aos="fade-up" data-aos-duration="800" data-aos-delay="${20*(i+.8)}">\n\t          <div class="card-ai d-grid"">\n\t            <div class="card-ai-image start-chat" data-index="${i}"><img src="${array_employees[i].image}" onerror="this.src='img/no-image.svg'" alt="${array_employees[i].name}" title="${array_employees[i].name}" data-index="${i}" class='open-modal'></div>\n\t            <div class="card-ai-bottom">\n\t              <div class="card-ai-name"><h3>${array_employees[i].name}</h3></div>\n\t              <div class="card-ai-job"><span>${array_employees[i].expert}</span></div>\n\t              <span class="btn btn-primary btn-md start-chat" data-index="${i}">${lang.translate[lang_index].chat_now}</span>\n\t            </div>\n\t          </div>\n\t        </div>\n\n        `);chat_history&&(arr2=JSON.parse(localStorage.getItem("smartanimals_chat_v2")),array_employees.forEach((e=>{const t=arr2&&arr2.find((t=>t.name===e.name));t&&(e.last_chat=t.last_chat)}))),translate(),$("#loading").fadeOut();const r=new URLSearchParams(window.location.search);if(r.has("chat")){const e=r.get("chat");displayChat(0,array_employees.findIndex((t=>t.name===e)))}})).catch((e=>{throw e}))}function currentDate(){return(new Date).toLocaleString()}"file:"===window.location.protocol&&alert("This file is not runnable locally, an http server is required, please read the documentation."),loadData("json/config.json",["json/employees.json","json/lang.json","json/badwords.json"]);const placeholder="img/placeholder.svg";function isElementInViewport(e){const t=e.get(0).getBoundingClientRect();return t.bottom>=0&&t.right>=0&&t.top<=$(window).height()&&t.left<=$(window).width()}async function getResponse(e){""!=$("#selectTone").val()&&(e+="↵↵ Please write in "+$("#selectTone").val()+" tone."),""!=$("#selectWritingStyle").val()&&(e+="↵↵ "+$("#selectWritingStyle").val()+" writing style."),""!=$("#selectLanguage").val()&&(e+="↵↵Answer in language "+$("#selectLanguage").val()+"."),array_chat.push({name:"User",message:e,isImg:!1,date:currentDate()}),array_messages=[];for(let e=0;e<array_chat.length;e++){let t={role:"",content:""};if(!0===array_chat[e].training){let t={role:"system",content:array_chat[e].message};array_messages.push(t)}else"User"===array_chat[e].name?t.role="user":t.role="assistant",t.content=array_chat[e].message,array_messages.push(t)}if(array_messages.length>max_num_chats_api){var t=max_num_chats_api-2;array_messages=array_messages.slice(0,2).concat(array_messages.slice(-t))}const a=new URLSearchParams;a.append("array_chat",JSON.stringify(array_messages)),a.append("employee_name",employee_name),a.append("model",API_MODEL),a.append("temperature",employee_temperature),a.append("frequency_penalty",employee_frequency_penalty),a.append("presence_penalty",employee_presence_penalty);try{const e=generateUniqueID();source=new SSE(CHAT_PHP_url,{headers:{"Content-Type":"application/x-www-form-urlencoded"},payload:a,method:"POST"}),streamChat(source,e),source.stream(),$("#overflow-chat").append(`\n\n        <div class="conversation-thread thread-ai">\n          ${avatar_in_chat}\n          <div class="message-container">\n            <div class="message-info">\n\t\t\t\t\t\t${copy_text_in_chat}\n\t\t\t\t\t\t${audio_in_chat}            \n              <div class="user-name"><h5>${employee_name}</h5></div>\n              <div class="message-text">\n                <div class="chat-response ${e}"><span class='get-stream'></span><span class='cursor'></span></div>\n              </div>\n              <div class="date-chat"><img src="img/icon-clock.svg"> ${currentDate()}</div>\n            </div>\n          </div>\n        </div>\n\t\t\t`),$(`.chat_${e} .chat-audio`).hide(),scrollChatBottom()}catch(e){console.error(`Error creating SSE: ${e}`)}}function generateUniqueID(e="id_"){return`${e}${Date.now()}`}function streamChat(e,t){let a="",n="";e.addEventListener("message",(function(e){let s=e.data,o={};if("string"==typeof s){if(s.startsWith("[ERROR]")){let e=s.substr(7).trim();return toastr.error(e),void enableChat()}if("[DONE]"===s)return $(".cursor").remove(),str=$(`.${t}`).html(),str=escapeHtml(str),$(`.${t}`).html(str),$(`.chat_${t} .chat-audio`).fadeIn("slow"),enableChat(),scrollChatBottom(),use_text_stream||($(`.${t}`).append(a),scrollChatBottom()),array_chat.push({name:employee_name,message:a,date:currentDate()}),checkClearChatDisplay(),saveChatHistory(),!1;try{o=JSON.parse(s)}catch(e){if(s)return void console.log(s)}}if(o&&o.error&&(!o.choices||0===o.choices.length))return toastr.error("❌ "+o.message),enableChat(),$(`.chat_${t}`).remove(),!1;if(o.choices&&o.choices.length>0){var i=is_model_turbo?o.choices[0].delta:o.choices[0];n="",(i.content||i.text)&&(a+=i.content||i.text,n=i.content||i.text),use_text_stream&&($(`.${t} .get-stream`).append(formatSpecialCharactersRealTime(n)),scrollChatBottom())}}))}function saveChatHistory(){array_employees[data_index].last_chat=array_chat,chat_history&&localStorage.setItem("smartanimals_chat_v2",JSON.stringify(array_employees)),console.log("Saving...")}function responseChat(e){for(var t=0;t<filterBotWords.length;t++)-1!==e.indexOf(filterBotWords[t])&&(e=e.replace(filterBotWords[t],""));array_chat.push({name:employee_name,message:e,date:currentDate()}),e=escapeHtml(e),avatar_in_chat="",!0===display_avatar_in_chat&&(avatar_in_chat=`<div class="user-image"><img src="${employee_image}" alt="${employee_name}" title="${employee_name}"></div>`),audio_in_chat="",!0===display_audio_button_answers&&(audio_in_chat="<div class='chat-audio'><img data-play=\"false\" src='img/btn_tts_play.svg'></div>"),$("#overflow-chat").append(`\n        <div class="conversation-thread thread-ai">\n          ${avatar_in_chat}\n          <div class="message-container">\n            <div class="message-info">\n\t\t\t\t\t\t${copy_text_in_chat}\n\t\t\t\t\t\t${audio_in_chat}            \n              <div class="user-name"><h5>${employee_name}</h5></div>\n              <div class="message-text">\n                <div class="chat-response">${e}</div>\n                <div class="date-chat"><img src="img/icon-clock.svg"> ${currentDate()}</div>\n              </div>\n            </div>\n          </div>\n        </div>\n\t\t\t`),scrollChatBottom(),enableChat(),saveChatHistory(),checkClearChatDisplay()}function appendChatImg(e){const t=Date.now();IAimagePrompt=e.replace("/img ",""),$("#overflow-chat").append(`\n\n        <div class="conversation-thread thread-ai">\n          <div class="message-container">\n            <div class="message-info">   \n              <div class="user-name"><h5>${employee_name}</h5></div>\n              <div class="message-text">\n\t              <div class="chat-response no-white-space">\n\t              <p>${lang.translate[lang_index].creating_ia_image} <strong class='ia-image-prompt-label'>${IAimagePrompt}</strong>\n                <div class="wrapper-image-ia image_ia_${t}">\n\t                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="40" height="40">\n\t                  <circle cx="50" cy="50" r="40" stroke="#c5c5c5" stroke-width="8" fill="none" />\n\t                  <circle cx="50" cy="50" r="40" stroke="#249ef7" stroke-width="8" fill="none" stroke-dasharray="250" stroke-dashoffset="0">\n\t                    <animate attributeName="stroke-dashoffset" dur="2s" repeatCount="indefinite" from="0" to="250" />\n\t                  </circle>\n\t                </svg>\n                </div>\n                <p class='expire-img-message'>${lang.translate[lang_index].expire_img_message}</p>\t\t\t\t\t              \n\t              </div>\n              </div>\n            </div>\n              <div class='date-chat'><img src='img/icon-clock.svg'> ${currentDate()}</div>\n          </div>\n        </div>\n\t\t\t`),scrollChatBottom(),$("#chat").val("");const a={model:"image-alpha-001",prompt:IAimagePrompt,num_images:dalle_generated_img_count,size:dalle_img_size};fetch(DALLE_PHP_url,{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then((e=>e.json())).then((e=>{if(1==e.status){$(".wrapper-image-ia svg").remove();const a=e.message.data;for(let e=0;e<a.length;e++)$(".image_ia_"+t).append(`<div class="image-ia"><img onerror="this.src='img/no-image.svg'" src="${a[e].url}"></div>`);const n=a.map((e=>e.url));array_chat.push({name:"User",message:lang.translate[lang_index].creating_ia_image_chat_instruction+" "+IAimagePrompt,isImg:!0,imgURL:n,date:currentDate()}),scrollChatBottom(),enableChat(),saveChatHistory()}else toastr.error("❌ "+e.message),enableChat()}))}function sendUserChat(){let e=$("#chat").val();if(filter_badwords){const t=new RegExp(`\\b(${badWords.join("|")})(?=\\s|$)`,"gi");if(t.test(e)){const a=e.replace(t,(e=>"*".repeat(e.length)));return $("#chat").val(a),toastr.error(`${lang.translate[lang_index].badword_feedback}`),!1}}if(e.length<chat_minlength)return toastr.error(`${lang.translate[lang_index].error_chat_minlength} ${chat_minlength} ${lang.translate[lang_index].error_chat_minlength_part2}`),!1;e=escapeHtml(e),$("#overflow-chat").append(`\n        <div class="conversation-thread thread-user">\n          <div class="message-container">\n            <div class="message-info">\n\t\t\t\t\t\t${copy_text_in_chat}\n\t\t\t\t\t\t${audio_in_chat}            \n              <div class="user-name"><h5>${lang.translate[lang_index].you}</h5></div>\n              <div class="message-text"><div class="chat-response">${e}</div></div>\n              <div class="date-chat"><img src="img/icon-clock.svg"> ${currentDate()}</div>\n            </div>\n          </div>\n        </div>\n\t\t\t`),scrollChatBottom(),hljs.highlightAll(),e.includes("/img")?appendChatImg(e):getResponse(e),$("#chat").val(""),disableChat()}function shuffleArray(e){return e.sort((()=>Math.random()-.5))}function translate(){translationObj=lang.translate[lang_index];for(let e in translationObj){let t=translationObj[e];document.body.querySelectorAll("*:not(script):not(style)").forEach((function(a){for(let n=0;n<a.childNodes.length;n++){let s=a.childNodes[n];if(s.nodeType===Node.TEXT_NODE){let a=s.nodeValue,n=new RegExp(`{{\\s*${e}\\s*}}`,"g");n.test(a)&&(s.parentElement.innerHTML=a.replace(n,t))}else if(s.nodeType===Node.ELEMENT_NODE){let a=s.attributes;for(let n=0;n<a.length;n++){let o=a[n];if(o.value.includes(`{{${e}}}`)){let a=o.value.replace(`{{${e}}}`,t);s.setAttribute(o.name,a)}}}}}))}}function closeChat(){hideChat(),enableChat(),$(window).scrollTop(scrollPosition),$("header").removeClass("header-min"),$("footer").show()}function stopChat(){source&&(enableChat(),source.close(),$(".cursor").remove())}function hideChat(){hideFeedback(),cancelSpeechSynthesis(),$(".hide-section").show(),$("#chat-background").hide()}function displayChat(e,t=""){cancelSpeechSynthesis(),$("footer").hide(),stopChat(),scrollPosition=$(this).scrollTop(),$("header").addClass("header-min"),$(".hide-section").hide(),$("#chat-background").show();var a=!1;if(""===t?data_index=e.attr("data-index"):(a=!0,data_index=t),$(".ai-contacts-item").removeClass("ai-contacts-item-active"),$(".ai_contacts_active_"+data_index).addClass("ai-contacts-item-active"),a){var n=$(".ai-contacts-item-active"),s=$(".ai-contacts-scroll");n.prependTo(s)}if(array_messages=[],$("#overflow-chat").html(""),$(".mobile-menu-toogle").hide(),array_chat=[],API_MODEL=array_employees[data_index].API_MODEL,is_model_turbo=API_MODEL.includes("-turbo"),employee_name=array_employees[data_index].name,employee_expert=array_employees[data_index].expert,employee_image=array_employees[data_index].image,employee_background_color=array_employees[data_index].background_thumb_color,employee_temperature=array_employees[data_index].temperature,employee_frequency_penalty=array_employees[data_index].frequency_penalty,employee_presence_penalty=array_employees[data_index].presence_penalty,employee_training=array_employees[data_index].training,displayWelcomeMessage=array_employees[data_index].display_welcome_message,welcome_message=array_employees[data_index].welcome_message,chat_minlength=array_employees[data_index].chat_minlength,chat_maxlength=array_employees[data_index].chat_maxlength,max_num_chats_api=array_employees[data_index].max_num_chats_api,google_voice=array_employees[data_index].google_voice,google_voice_lang_code=array_employees[data_index].google_voice_lang_code,lastChatLength=array_employees[data_index]&&array_employees[data_index].last_chat?array_employees[data_index].last_chat.length:[],setURLChat(employee_name),$(".ai-chat-top-image img").attr("src",employee_image),$(".ai-chat-top-name").html(`<h4>${employee_name} <span class="online-bullet"></span></h4>`),$(".ai-chat-top-job").html(employee_expert),$("#chat").val(""),$("#chat").attr("maxlength",chat_maxlength),lastChatLength>2)loadChat();else{const e={name:employee_name,message:employee_training,training:!0,date:currentDate()};array_chat.push(e),displayWelcomeMessage&&responseChat(array_employees[data_index].welcome_message)}return!1}$(window).on("scroll",(function(){$("img[data-src]").each((function(){isElementInViewport($(this))&&($(this).attr("src",$(this).attr("data-src")),$(this).removeAttr("data-src"))}))})),$("#chat").keypress((function(e){if(13===e.which&&!e.shiftKey)return sendUserChat(),!1})),$(".btn-send-chat").on("click",(function(){sendUserChat()})),$(".btn-cancel-chat").on("click",(function(){stopChat()})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&closeChat()})),$(document).delegate(".ai-contacts-item","click",(function(){displayChat($(this))})),$(document).delegate(".start-chat","click",(function(){displayChat($(this))}));const formatSpecialCharactersRealTime=e=>(new DOMParser).parseFromString(`<!doctype html><body>${e}`,"text/html").body.textContent,escapeHtml=e=>(e=e.replace(/↵↵.*?\./gs,""),/<code>|<\/code>|<pre>|<\/pre>/g.test(e)?e:e=(e=(e=(e=(e=e.replace(/[&<>"'`{}()\[\]]/g,(e=>{switch(e){case"<":return"&lt;";case">":return"&gt;";case"{":return"&#123;";case"}":return"&#125;";case"(":return"&#40;";case")":return"&#41;";case"[":return"&#91;";case"]":return"&#93;";default:return e}}))).replace(/(https?:\/\/[^\s]+|www\.[^\s]+|\b(?:[a-z\d]+\.){1,2}[a-z]{2,}\b)/gi,(e=>`<a href="${e.startsWith("http")?e:"https://"+e}" target="_blank" rel="noopener noreferrer">${e}</a>`))).replace(/&lt;span\s+class="get-stream"&gt;/g,"")).replace(/&lt;\/span&gt;/g,"")).replace(/```(\w+)?([\s\S]*?)```/g,'<pre><code>$2</code><button class="copy-code" onclick="copyCode(this)"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> <span class="label-copy-code">'+lang.translate[lang_index].copy_code1+"</span></button></pre>").replace(/(\d+\.\s)/g,"<strong>$1</strong>").replace(/(^[A-Za-z\s]+:)/gm,"<strong>$1</strong>"));function copyText(e){const t=e.parentElement.querySelector(".chat-response"),a=document.createRange();a.selectNode(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(a),document.execCommand("copy"),window.getSelection().removeAllRanges(),e.innerHTML=lang.translate[lang_index].copy_text2}function copyCode(e){const t=e.parentElement.querySelector("code"),a=document.createRange();a.selectNode(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(a),document.execCommand("copy"),window.getSelection().removeAllRanges(),e.innerHTML=lang.translate[lang_index].copy_code2}function clearChat(e){Swal.fire({title:lang.translate[lang_index].confirmation_delete_chat1,text:lang.translate[lang_index].confirmation_delete_chat2,icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:lang.translate[lang_index].confirmation_delete_chat3,cancelButtonText:lang.translate[lang_index].confirmation_delete_chat4}).then((t=>{if(t.isConfirmed){if("all"==e){for(var a=0;a<array_employees.length;a++)array_employees[a].last_chat=[];Swal.fire(lang.translate[lang_index].confirmation_delete_chat5,lang.translate[lang_index].confirmation_delete_chat_all,"success")}else array_employees[data_index].last_chat=[],Swal.fire(lang.translate[lang_index].confirmation_delete_chat5,lang.translate[lang_index].confirmation_delete_current_chat,"success");$("#overflow-chat").html(""),array_chat=[],array_chat.push({name:employee_name,message:employee_training,training:!0,isImg:!1,date:currentDate()}),localStorage.setItem("smartanimals_chat_v2",JSON.stringify(array_employees)),displayWelcomeMessage&&responseChat(array_employees[data_index].welcome_message)}}))}function loadChat(){if(chat_history){checkClearChatDisplay();for(var e=0;e<array_employees[data_index].last_chat.length;e++){const t=array_employees[data_index].last_chat[e];if("User"===t.name)if(!0===t.isImg){const e=Date.now(),a=(Array.isArray(t.imgURL)&&t.imgURL.map((e=>e)).join(""),Array.isArray(t.imgURL)?t.imgURL.map((e=>`<div class="image-ia"><img onerror="this.src='img/no-image.svg'" src="${e}"></div>`)).join(""):""),n=`\n\t\t\t\t        <div class="conversation-thread thread-ai">\n\t\t\t\t          <div class="message-container">\n\t\t\t\t            <div class="message-info">\n\t\t\t\t              <div class="user-name"><h5>${employee_name}</h5></div>\n\t\t\t\t              <div class="message-text">\n\t\t\t\t\t              <div class="chat-response no-white-space">\n\t\t\t\t\t              <p>${lang.translate[lang_index].creating_ia_image} <strong class='ia-image-prompt-label'>${t.message}</strong>\n\t\t\t                  <div class="wrapper-image-ia image_ia_${e}">\n\t\t\t                    ${a}\n\t\t\t                  </div>\n\t\t\t                  <p class='expire-img-message'>${lang.translate[lang_index].expire_img_message}</p>\t\t\t\t\t              \n\t\t\t\t\t              </div>\n\t\t\t\t              </div>\n\t\t\t\t            </div>\n\t\t\t\t              <div class='date-chat'><img src='img/icon-clock.svg'> ${t.date||""}</div>\n\t\t\t\t          </div>\n\t\t\t\t        </div>\n\t\t          `;$("#overflow-chat").append(n),array_chat.push({name:"User",message:t.message,isImg:!0,imgURL:t.imgURL,date:currentDate()})}else{const e=escapeHtml(t.message),a=`\n\t\t\t\t        <div class="conversation-thread thread-user">\n\t\t\t\t          <div class="message-container">\n\t\t\t\t            <div class="message-info">\n\t\t\t\t\t\t\t\t\t\t${copy_text_in_chat}\n\t\t\t\t\t\t\t\t\t\t${audio_in_chat}            \n\t\t\t\t              <div class="user-name"><h5>${lang.translate[lang_index].you}</h5></div>\n\t\t\t\t              <div class="message-text">\n\t\t\t\t              <div class="chat-response">${e}</div>\n\t\t\t\t              </div>\n\t\t\t\t              <div class='date-chat'><img src='img/icon-clock.svg'> ${t.date||""}</div>\n\t\t\t\t            </div>\n\t\t\t\t          </div>\n\t\t\t\t        </div>\n\t\t          `;$("#overflow-chat").append(a),array_chat.push({name:"User",message:t.message,isImg:!1,date:currentDate()})}else{if(avatar_in_chat=display_avatar_in_chat?`<div class="user-image"><img onerror="this.src='img/no-image.svg'" src="${employee_image}" alt="${employee_name}" title="${employee_name}"></div>`:"",audio_in_chat=display_audio_button_answers?"<div class='chat-audio'><img data-play=\"false\" src='img/btn_tts_play.svg'></div>":"",!t.training){const e=escapeHtml(t.message),a=`\n\n\t\t\t\t        <div class="conversation-thread thread-ai">\n\t\t\t\t          ${avatar_in_chat}\n\t\t\t\t          <div class="message-container">\n\t\t\t\t            <div class="message-info">\n\t\t\t\t\t\t\t\t\t\t${copy_text_in_chat}\n\t\t\t\t\t\t\t\t\t\t${audio_in_chat}            \n\t\t\t\t              <div class="user-name"><h5>${t.name}</h5></div>\n\t\t\t\t              <div class="message-text">\n\t\t\t\t              \t<div class="chat-response">${e}</div>\n\t\t\t\t              </div>\n\t\t\t\t              <div class='date-chat'><img src='img/icon-clock.svg'> ${t.date||""}</div>\n\t\t\t\t            </div>\n\t\t\t\t          </div>\n\t\t\t\t        </div>\n\t\t          `;$("#overflow-chat").append(a)}array_chat.push({name:employee_name,message:t.message,training:t.training,date:currentDate()})}}hljs.highlightAll(),setTimeout((function(){scrollChatBottom()}),10)}else displayWelcomeMessage&&responseChat(welcome_message)}function checkClearChatDisplay(){array_employees[data_index].last_chat.length>1?chat_history&&$("#clear-chat").show():$("#clear-chat").hide();array_employees.some((e=>e.last_chat&&e.last_chat.length>2))?$("#clear-all-chats").show():$("#clear-all-chats").hide()}function hideFeedback(){toastr.remove()}function scrollChatBottom(){let e=document.getElementById("overflow-chat");e.scrollTop=e.scrollHeight,hljs.highlightAll(),setTimeout((function(){window.innerWidth<768&&window.scrollTo(0,document.documentElement.scrollHeight)}),100)}function enableChat(){$(".character-typing").css("visibility","hidden"),$(".btn-send-chat,#chat").attr("disabled",!1),$(".btn-send-chat").show(),$(".btn-cancel-chat").hide(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||setTimeout((function(){$("#chat").focus()}),300)}function disableChat(){$(".character-typing").css("visibility","visible"),$(".character-typing").css("display","flex"),$(".character-typing span").html(employee_name),$(".btn-send-chat,#chat").attr("disabled",!0),$(".btn-send-chat").hide(),$(".btn-cancel-chat").show()}function createTextFile(e){let t="";e.shift(),e.forEach((e=>{t+=`${e.name}: ${e.message}\r\n`})),t=t.replace("User:",lang.translate[lang_index].you+":");return new Blob([t],{type:"text/plain"})}function downloadPdf(){for(var e={content:[{text:lang.translate[lang_index].header_title_pdf,style:"header"},"\n"],styles:{header:{fontSize:22,bold:!0},name:{fontSize:14,color:"#0072c6",bold:!0},message:{fontSize:12,color:"#2c2c2c",bold:!1,lineHeight:1.2,marginTop:4},date:{marginTop:5,fontSize:10,color:"#787878"},defaultStyle:{font:"Roboto"}}},t=1;t<array_chat.length;t++){var a=array_chat[t],n={text:a.name+": ",style:"name"},s={text:a.message.replace(/\p{Emoji}/gu,"").replace(/↵↵.*?\./gs,""),style:"message"};e.content.push(n),e.content.push(s),e.content.push({text:a.date,style:"date"}),e.content.push("\n")}pdfMake.createPdf(e).download("chat.pdf")}function downloadFile(e,t){const a=URL.createObjectURL(e),n=document.createElement("a");n.href=a,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n)}function handleDownload(){downloadFile(createTextFile(array_chat.map((e=>{const t=e.message.replace(/\p{Emoji}/gu,"").replace(/↵↵.*?\./gs,"");return{...e,message:t}}))),"chat.txt")}function cleanString(e){return e=e.trim().replace(/<[^>]*>/g,"").replace(/[\u{1F600}-\u{1F64F}|\u{1F300}-\u{1F5FF}|\u{1F680}-\u{1F6FF}|\u{2600}-\u{26FF}|\u{2700}-\u{27BF}|\u{1F900}-\u{1F9FF}|\u{1F1E0}-\u{1F1FF}|\u{1F200}-\u{1F2FF}|\u{1F700}-\u{1F77F}|\u{1F780}-\u{1F7FF}|\u{1F800}-\u{1F8FF}|\u{1F900}-\u{1F9FF}|\u{1FA00}-\u{1FA6F}|\u{1FA70}-\u{1FAFF}]/gu,"").replace(/<div\s+class="date-chat".*?<\/div>/g,"").replace(/\n/g,"")}function cancelSpeechSynthesis(){window.speechSynthesis&&window.speechSynthesis.cancel()}function doSpeechSynthesis(e,t){$("span.chat-response-highlight").each((function(){$(this).replaceWith($(this).text())}));const a=[...(e=cleanString(e)).matchAll(/[,.?!]/g)].map((e=>e.index)),n=[];let s=0;for(let t=0;t<a.length;t++)a[t]-s<100||(n.push(e.substring(s,a[t]+1)),s=a[t]+1);s<e.length&&n.push(e.substring(s));const o=n.map((e=>{const t=new SpeechSynthesisUtterance(e);if(t.lang=google_voice_lang_code,t.voice=speechSynthesis.getVoices().find((e=>e.name===google_voice)),!t.voice){const e=array_voices.find((e=>e.lang===t.lang));e&&(t.voice=speechSynthesis.getVoices().find((t=>t.name===e.name)))}return t}));o[o.length-1].addEventListener("end",(()=>{$(".chat-audio img").attr("src","img/btn_tts_play.svg"),$(".chat-audio img").attr("data-play","false")}));!function a(s=0){if(s<o.length){const i=n[s];e.indexOf(i);t.html(t.html().replace(i,`<span class="chat-response-highlight">${i}</span>`)),speechSynthesis.speak(o[s]),o[s].addEventListener("end",(()=>{t.html(t.html().replace(`<span class="chat-response-highlight">${i}</span>`,i)),a(s+1)})),speechSynthesis.addEventListener("pause",(()=>{t.html(t.html().replace(`<span class="chat-response-highlight">${i}</span>`,i))}),{once:!0})}}()}function displayVoices(){console.table(array_voices)}function getTextToSpeechVoices(){window.speechSynthesis.getVoices().forEach((function(e){const t={name:e.name,lang:e.lang};array_voices.push(t)}))}$(document).on("click",".chat-audio",(function(){var e=$(this),t=e.find("img"),a=e.siblings(".message-text"),n="true"==t.attr("data-play");if(n&&cancelSpeechSynthesis(),t.attr({src:"img/btn_tts_"+(n?"play":"stop")+".svg","data-play":n?"false":"true"}),!n){cancelSpeechSynthesis();var s=a.html().replace(/<button\b[^>]*\bclass="[^"]*\bcopy-code\b[^"]*"[^>]*>.*?<\/button>/gi,"");"speechSynthesis"in window&&doSpeechSynthesis(s,a)}})),window.speechSynthesis.onvoiceschanged=function(){getTextToSpeechVoices()};const myModalEl=document.getElementById("modalDefault");myModalEl.addEventListener("show.bs.modal",(e=>{$("#modalDefault .modal-title").html(array_employees[data_index].name),$("#modalDefault .modal-body").html(array_employees[data_index].description)}));const localStorageKey="col-contacts-border-display";let displayState=localStorage.getItem(localStorageKey);function setURLChat(e){const t=window.location.origin+window.location.pathname,a=new URLSearchParams(window.location.search);a.set("chat",e);const n=new URL(t);n.search=a.toString(),history.pushState({},"",n.href)}function backToTop(){window.scrollTo({top:0,behavior:"smooth"})}displayState?$(".col-contacts-border").css("display",displayState):$(".col-contacts-border").css("display","none"),$(".toggle_employees_list").on("click",(function(){$(".col-contacts-border").toggle(),displayState=$(".col-contacts-border").css("display"),localStorage.setItem(localStorageKey,displayState)})),toastr.options={closeButton:!0,debug:!1,newestOnTop:!1,progressBar:!0,positionClass:"toast-bottom-full-width",preventDuplicates:!0,onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"2000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"};const textarea=document.querySelector("#chat"),microphoneButton=document.querySelector("#microphone-button");let isTranscribing=!1;if("SpeechRecognition"in window||"webkitSpeechRecognition"in window){const e=new(window.SpeechRecognition||window.webkitSpeechRecognition);e.lang=microphone_speak_lang,e.continuous=!0,e.addEventListener("start",(()=>{$(".btn-send-chat").attr("disabled",!0),$("#microphone-button").attr("src","img/mic-stop.svg")})),e.addEventListener("result",(e=>{const t=e.results[0][0].transcript;textarea.value+=t+"\n"})),e.addEventListener("end",(()=>{$(".btn-send-chat").attr("disabled",!1),$("#microphone-button").attr("src","img/mic-start.svg"),isTranscribing=!1})),microphoneButton.addEventListener("click",(()=>{isTranscribing?(e.stop(),isTranscribing=!1):(e.start(),isTranscribing=!0)}))}else console.log("Web Speech Recognition API not supported by browser"),$("#microphone-button").hide();const arrow=$(".arrow-up");arrow.toggleClass("arrow-down arrow-up"),$(".btn-options-input").click((function(){arrow.hasClass("arrow-down")?(arrow.removeClass("arrow-down").addClass("arrow-up"),$(".col-options-input .form-floating").show()):(arrow.removeClass("arrow-up").addClass("arrow-down"),console.log("Arrow down"),$(".col-options-input .form-floating").hide())}));